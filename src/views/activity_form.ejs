<%- include('layouts/main') %>
<%- include('partials/navbar') %>
<div class="container">
  <h1>ایجاد <%= entity.displayName %></h1>
  <form action="/crm/create-activity/<%= entity.logicalName %>" method="POST" id="activityForm">
    <div class="mb-3">
      <label for="subject" class="form-label">موضوع</label>
      <input type="text" class="form-control" id="subject" name="subject" required>
    </div>
    
    <div class="mb-3">
      <label for="description" class="form-label">توضیحات</label>
      <textarea class="form-control" id="description" name="description" rows="3"></textarea>
    </div>
    
    <div class="mb-3">
      <label for="scheduledstart" class="form-label">تاریخ شروع</label>
      <div class="input-group">
        <input type="text" 
               class="form-control jalali-datepicker" 
               id="scheduledstart_display" 
               placeholder="YYYY/MM/DD HH:mm:ss"
               autocomplete="off"
               required />
        <input type="hidden" 
               name="scheduledstart" 
               id="scheduledstart" />
      </div>
    </div>
    
    <div class="mb-3">
      <label for="scheduledend" class="form-label">تاریخ پایان</label>
      <div class="input-group">
        <input type="text" 
               class="form-control jalali-datepicker" 
               id="scheduledend_display" 
               placeholder="YYYY/MM/DD HH:mm:ss"
               autocomplete="off"
               required />
        <input type="hidden" 
               name="scheduledend" 
               id="scheduledend" />
      </div>
    </div>
    
    <div class="mb-3">
      <label for="prioritycode" class="form-label">اولویت</label>
      <select class="form-select" id="prioritycode" name="prioritycode" required>
        <option value="0">کم</option>
        <option value="1">عادی</option>
        <option value="2">زیاد</option>
        <option value="3">فوری</option>
      </select>
    </div>
    
    <button type="submit" class="btn btn-primary">ایجاد فعالیت</button>
  </form>
  <a href="/crm/create-activity" class="btn btn-secondary mt-3">بازگشت به انتخاب فعالیت</a>
</div>

<!-- Add required CSS -->
<link rel="stylesheet" href="https://unpkg.com/persian-datepicker@latest/dist/css/persian-datepicker.min.css">

<!-- Add required scripts -->
<script src="https://unpkg.com/persian-date@latest/dist/persian-date.min.js"></script>
<script src="https://unpkg.com/persian-datepicker@latest/dist/js/persian-datepicker.min.js"></script>
<script src="/src/public/js/dateUtils.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Jalali date pickers
    $('.jalali-datepicker').persianDatepicker({
        format: 'YYYY/MM/DD HH:mm:ss',
        initialValue: false,
        autoClose: true,
        timePicker: {
            enabled: true,
            meridian: {
                enabled: false
            }
        },
        onSelect: function(unix) {
            const input = this.$inputElement[0];
            const hiddenInput = document.getElementById(input.id.replace('_display', ''));
            if (hiddenInput) {
                const date = new persianDate(unix);
                hiddenInput.value = date.toCalendar('gregorian').toISOString();
            }
        }
    });

    // Form submission handling
    document.getElementById('activityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate required date fields
        const dateInputs = document.querySelectorAll('.jalali-datepicker[required]');
        let isValid = true;
        
        dateInputs.forEach(input => {
            const hiddenInput = document.getElementById(input.id.replace('_display', ''));
            if (!hiddenInput.value) {
                isValid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (isValid) {
            this.submit();
        }
    });
});
</script>

<%- include('partials/scripts') %>